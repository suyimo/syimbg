(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{508:function(s,n,a){"use strict";a.r(n);var e=a(6),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"install"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install"}},[s._v("#")]),s._v(" install")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("brew tap denji/nginx && brew install nginx-full upload-nginx-module upload-progress-nginx-module lua-nginx-module\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h1",{attrs:{id:"编写nginx-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写nginx-conf"}},[s._v("#")]),s._v(" 编写nginx conf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#log_format  log_req_resp  \' [$time_local] "$request" $status \\n\'\n#\'req_header:"$req_header" \\n \'\n#\'resp_header:"$resp_header" \\n \';\n\nserver {\n    listen 8099;\n    set $yduploadrootdir "上传后文件存放根路径";\n    set $shellrootdir "脚本路径";\n    #access_log /Users/user/nginxStaticFile/logs/access.log log_req_resp;\n    #error_log  /Users/user/nginxStaticFile/logs/error.log  info;\n    server_name localhost;\n\n    charset utf-8;\n    client_max_body_size 200m;\n\n    #set $req_header "";\n    #set $resp_header "";\n    #header_filter_by_lua \'\n    #    local h1 = ngx.req.get_headers()\n    #    for k1, v1 in pairs(h1) do\n    #    ngx.var.req_header=ngx.var.req_header..k1..": "..v1\n    #    end\n    #\n    #    local h = ngx.resp.get_headers()\n    #    for k, v in pairs(h) do\n    #    ngx.var.resp_header=ngx.var.resp_header..k..": "..v\n    #    end\n    #\';\n\n    location / {\n\troot $yduploadrootdir/uploads;\n\tautoindex on;\n\tautoindex_exact_size off;# 显示文件大小\n\tautoindex_localtime on;# 显示文件时间\n\tcharset utf-8;\n    }\n\n    location /upload {\n\tupload_resumable on;\n        upload_state_store $yduploadrootdir/uploads/temp;\n        upload_pass /res_upload;\n        upload_set_form_field "file_tmp_path" $upload_tmp_path;\n\tupload_set_form_field "file_save_path" $yduploadrootdir/uploads/;\n\tupload_set_form_field "file_shell_path" $shellrootdir/;\n        upload_store $yduploadrootdir/uploads/temp;\n    }\n\n    location /res_upload {\n        default_type text/html;\n\tlua_need_request_body on;\n\tcontent_by_lua_file $shellrootdir/lua/upload.lua;# Lua脚本的位置\n        #return 200 URL;\n    }\n\n#location /lua {\n#default_type text/plain;\n#content_by_lua \'ngx.say("hello, lua")\';\n#}\n\n #   location /testlua {\n#\tdefault_type text/plain;\n#\tcontent_by_lua_file $yduploadrootdir/lua/test.lua;\n #   }\n}\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br")])]),a("h1",{attrs:{id:"脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#脚本"}},[s._v("#")]),s._v(" 脚本")]),s._v(" "),a("h2",{attrs:{id:"上传脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传脚本"}},[s._v("#")]),s._v(" 上传脚本")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('function onupload()\n    ngx.req.read_body();\n    local headers_tab = ngx.req.get_headers()\n    local post_args=ngx.req.get_post_args();\n    local table_params=getFormParams(post_args);\n\n    table_params["file_name"]=headers_tab["fileName"]\n    local shell_root_dir=table_params["file_shell_path"];\n    ret_val=processFile(table_params);\n    if (ret_val==0) then\n\n        local root_dir=table_params["file_save_path"];\n\n        local filename=table_params["file_name"];\n        local idx,_ = string.find(filename,"beta");\n        if (idx) then\n            ngx.say("http://host:port/"..headers_tab["fileName"])\n        else\n            if (headers_tab["gitRepo"] == "on") then\n                local t = io.popen(\'sh \'..shell_root_dir..\'/shell/url_get_nexus.sh \'..root_dir..\' \'..filename)\n                local url = t:read("*all")\n                ngx.say(url)\n            else\n                local t = io.popen(\'sh \'..shell_root_dir..\'/shell/url_get.sh \'..root_dir..\' \'..filename)\n                local url = t:read("*all")\n                ngx.say(url)\n            end\n        end\n    else\n        ngx.say("Something wrong with nginx!!")\n    end\nend\n\nfunction processFile(params)\n    local root_dir=params["file_save_path"]\n    local filename=params["file_name"];\n    local shell_root_dir=params["file_shell_path"];\n    deleteOldFile(filename,shell_root_dir);\n    local mv_command="mv "..trim(params["file_tmp_path"]).." "..root_dir..filename;\n\n    if (os.execute(mv_command)~=0)then\n        ngx.exec("/50x.html");\n        return 1;\n    else\n        return 0;\n    end\nend\n\nfunction trim(str)\n    if (str~=nil)then\n        return string.gsub(str, "%s+", "");\n    else\n        return nil;\n    end\nend\n\nfunction deleteOldFile(fileName,root_dir)\n    os.execute(\'sh \'..root_dir..\'/shell/delete.sh \'..root_dir..\' \'..fileName)\nend\n\n--提交过来的表单数据是一个超长的字符串,需要从这个字符串中解析出字典结构的数据,这样可以利用key来访问字典中对应的值\nfunction getFormParams(post_args)\n    local table_params={};\n    for key, val in pairs(post_args) do\n        str_params = key ..val\n    end\n\n    local str_start = " name";\n    local str_start_len = string.len(str_start);\n    local str_end = "%-%-";\n    local str_sign = "\\"";\n    local idx,idx_end = string.find(str_params,str_start);\n    local i = 0;\n\n    -- 如果字符串内仍有开始标记，则说明还有内容需要分离。继续分离到没内容为止。\n    while idx do\n        str_params = string.sub(str_params,idx_end); -- 截取开始标记后所有字符待用\n        i = string.find(str_params,str_sign); -- 查找字段名开始处的引号索引\n        str_params = string.sub(str_params,i+1); -- 去掉开始处的引号\n        i = string.find(str_params,str_sign); -- 查找字段名结束位置的索引\n        f_name = string.sub(str_params,0,i-1); -- 截取到字段名称\n        str_params = string.sub(str_params,i+1); -- 去掉名称字段以及结束时的引号\n        i,i2 = string.find(str_params,str_end); -- 查找字段值结尾标识的索引\n        f_value = string.sub(str_params,1,i-1); -- 截取到字段值\n        real_value=trim(f_value)\n        table_params[f_name] = real_value;\n        idx = string.find(str_params,str_start,0); -- 查找判断下一个字段是否存在的\n    end\n    return table_params\nend\n\nonupload();\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br")])]),a("h1",{attrs:{id:"启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[s._v("#")]),s._v(" 启动")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("brew services restart denji/nginx/nginx-full\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);